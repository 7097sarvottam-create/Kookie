<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kookie | Productivity Suite</title>
    <!-- External Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/peerjs/1.5.2/peerjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        /* --- Canva-inspired Clean Light Theme --- */
        :root {
            --primary: #764ba2;
            --primary-hover: #5e3a7e;
            --primary-light: #f3eef9;
            --accent: #00c4cc;
            
            --bg-body: #f4f5f7;
            --bg-surface: #ffffff;
            --bg-sidebar: #ffffff;
            
            --text-main: #2d3436;
            --text-secondary: #636e72;
            --text-light: #b2bec3;
            
            --border-color: #dfe6e9;
            --shadow-sm: 0 2px 8px rgba(0,0,0,0.04);
            --shadow-md: 0 8px 24px rgba(0,0,0,0.08);
            --radius-md: 12px;
            --radius-lg: 20px;
            
            --sidebar-width: 260px;
            --font-family: 'Inter', sans-serif;
        }

        /* --- Dark Mode Overrides --- */
        [data-theme="dark"] {
            --bg-body: #121212;
            --bg-surface: #1e1e1e;
            --bg-sidebar: #181818;
            --text-main: #e0e0e0;
            --text-secondary: #a0a0a0;
            --border-color: #333333;
            --shadow-sm: 0 2px 8px rgba(0,0,0,0.2);
            --shadow-md: 0 8px 24px rgba(0,0,0,0.4);
            --primary-light: rgba(118, 75, 162, 0.25);
        }

        * { box-sizing: border-box; outline: none; }
        
        body {
            margin: 0;
            font-family: var(--font-family);
            background-color: var(--bg-body);
            color: var(--text-main);
            height: 100vh;
            overflow: hidden;
            display: flex;
            transition: background-color 0.3s, color 0.3s;
        }

        /* --- Animations --- */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideInLeft { from { opacity: 0; transform: translateX(-20px); } to { opacity: 1; transform: translateX(0); } }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* --- Startup Overlay --- */
        #startup-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg-surface); z-index: 9999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            transition: opacity 0.8s ease-in-out;
        }
        .loader-ring {
            width: 60px; height: 60px; border: 4px solid rgba(118, 75, 162, 0.1);
            border-top: 4px solid var(--primary); border-radius: 50%;
            animation: spin 1s linear infinite; margin-bottom: 30px;
        }
        .loading-text { font-size: 1.8rem; font-weight: 700; color: var(--text-main); margin-bottom: 10px; letter-spacing: -0.5px; }
        .loading-sub { color: var(--text-secondary); font-size: 1rem; font-weight: 500; min-height: 1.2em; }
        .startup-progress { width: 200px; height: 4px; background: rgba(0,0,0,0.05); border-radius: 2px; margin-top: 20px; overflow: hidden; }
        .startup-bar { height: 100%; background: var(--primary); width: 0%; transition: width 0.1s linear; }

        /* --- Sidebar --- */
        #sidebar {
            width: var(--sidebar-width); background: var(--bg-sidebar); border-right: 1px solid var(--border-color);
            display: flex; flex-direction: column; padding: 24px 16px; z-index: 100;
            opacity: 0; animation: slideInLeft 0.6s ease-out forwards; animation-delay: 5.2s;
        }
        .logo-area { display: flex; align-items: center; gap: 12px; margin-bottom: 32px; padding: 0 12px; }
        .logo-icon { font-size: 28px; color: var(--primary); }
        .logo-text { font-size: 22px; font-weight: 800; color: var(--text-main); letter-spacing: -0.5px; }
        .nav-item {
            display: flex; align-items: center; gap: 16px; padding: 12px 16px; margin-bottom: 4px;
            border-radius: var(--radius-md); cursor: pointer; color: var(--text-secondary); font-weight: 500; transition: all 0.2s ease;
        }
        .nav-item:hover { background-color: var(--bg-body); color: var(--text-main); }
        .nav-item.active { background-color: var(--primary-light); color: var(--primary); font-weight: 600; }
        .nav-icon { width: 20px; text-align: center; font-size: 1.1rem; }

        /* --- Main Content --- */
        #main-content {
            flex: 1; padding: 0; overflow-y: auto; position: relative;
            opacity: 0; animation: fadeIn 0.8s ease-out forwards; animation-delay: 5.2s;
            display: flex; flex-direction: column;
        }
        .section { display: none; max-width: 1200px; margin: 0 auto; padding: 32px 48px; }
        .section.active { display: block; animation: fadeIn 0.4s ease-out; }
        h2 { font-size: 28px; margin-bottom: 24px; font-weight: 700; color: var(--text-main); letter-spacing: -0.5px; }

        /* --- User Profile Bar (NEW) --- */
        .user-profile-bar {
            background: var(--bg-surface);
            border-bottom: 1px solid var(--border-color);
            padding: 16px 32px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: var(--shadow-sm);
            z-index: 500;
        }
        .profile-left { display: flex; align-items: center; gap: 16px; }
        .profile-avatar {
            width: 48px; height: 48px; border-radius: 50%;
            background: var(--primary); color: white;
            display: flex; align-items: center; justify-content: center;
            font-size: 1.5rem; font-weight: 700;
            box-shadow: 0 4px 10px rgba(118, 75, 162, 0.3);
            cursor: pointer; transition: transform 0.2s;
        }
        .profile-avatar:hover { transform: scale(1.05); }
        .profile-details { display: flex; flex-direction: column; }
        .profile-name { font-size: 1.1rem; font-weight: 700; color: var(--text-main); }
        .profile-meta { font-size: 0.85rem; color: var(--text-secondary); display: flex; gap: 12px; align-items: center; }
        .profile-tag { background: var(--primary-light); color: var(--primary); padding: 4px 8px; border-radius: 4px; font-weight: 600; font-size: 0.75rem; }
        .edit-profile-btn { color: var(--primary); font-weight: 600; font-size: 0.9rem; cursor: pointer; display: flex; align-items: center; gap: 6px; transition: 0.2s; }
        .edit-profile-btn:hover { color: var(--primary-hover); }

        /* --- Components --- */
        .card {
            background: var(--bg-surface); border: 1px solid var(--border-color);
            border-radius: var(--radius-lg); padding: 32px; margin-bottom: 24px;
            box-shadow: var(--shadow-sm); transition: box-shadow 0.2s, border-color 0.2s;
        }
        .card:hover { box-shadow: var(--shadow-md); }

        button {
            border: none; padding: 10px 20px; border-radius: var(--radius-md); cursor: pointer;
            font-weight: 600; font-size: 0.9rem; display: inline-flex; align-items: center; gap: 8px;
            transition: all 0.2s; font-family: var(--font-family);
        }
        button:disabled { opacity: 0.6; cursor: not-allowed; }
        .btn-primary { background: linear-gradient(135deg, var(--primary) 0%, #8e44ad 100%); color: white; box-shadow: 0 4px 12px rgba(118, 75, 162, 0.2); }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 6px 16px rgba(118, 75, 162, 0.3); }
        .btn-secondary { background: var(--bg-surface); border: 1px solid var(--border-color); color: var(--text-main); }
        .btn-secondary:hover { background-color: var(--bg-body); border-color: var(--text-secondary); }
        .btn-danger { background: #fff1f0; color: #ff4d4f; border: 1px solid #ffccc7; }
        .btn-danger:hover { background: #ffccc7; }

        .btn-loading { color: transparent !important; pointer-events: none; position: relative; }
        .btn-loading::after {
            content: ""; position: absolute; top: 50%; left: 50%; margin: -8px; width: 16px; height: 16px;
            border: 2px solid rgba(255,255,255,0.3); border-top-color: #fff; border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        input, select, textarea {
            background: var(--bg-surface); border: 1px solid var(--border-color); color: var(--text-main);
            padding: 10px 14px; border-radius: var(--radius-md); width: 100%; font-size: 0.95rem;
            font-family: var(--font-family); transition: border 0.2s, box-shadow 0.2s;
        }
        input:focus, textarea:focus, select:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(118, 75, 162, 0.1); }

        /* --- Timer --- */
        .timer-container { text-align: center; padding: 40px 20px; }
        .timer-display { font-size: 6rem; font-weight: 700; color: var(--text-main); margin: 20px 0; letter-spacing: -2px; font-variant-numeric: tabular-nums; }
        .timer-modes { display: flex; justify-content: center; gap: 12px; margin-bottom: 24px; }
        .mode-btn { border-radius: 20px; padding: 6px 16px; font-size: 0.85rem; }
        .mode-btn.active { background: var(--text-main); color: white; border-color: var(--text-main); }
        .progress-bar-bg { width: 100%; height: 6px; background: rgba(0,0,0,0.05); border-radius: 3px; overflow: hidden; margin-top: 24px; }
        .progress-bar-fill { height: 100%; background: var(--primary); width: 100%; transition: width 1s linear; }

        /* --- Chat --- */
        .chat-layout { display: flex; flex-direction: column; height: 600px; gap: 20px; }
        .chat-history { flex: 1; overflow-y: auto; padding: 24px; background: var(--bg-body); border-radius: var(--radius-lg); display: flex; flex-direction: column; gap: 16px; border: 1px solid var(--border-color); }
        .message { max-width: 80%; padding: 16px 20px; border-radius: 18px; line-height: 1.6; font-size: 0.95rem; animation: fadeIn 0.3s; box-shadow: 0 2px 4px rgba(0,0,0,0.02); position: relative; }
        .msg-ai { background: var(--bg-surface); align-self: flex-start; border-bottom-left-radius: 4px; color: var(--text-main); border: 1px solid var(--border-color); }
        .msg-ai::before { content: 'Kookie'; position: absolute; top: -18px; left: 0; font-size: 0.75rem; color: var(--text-secondary); font-weight: 600; }
        .msg-user { background: var(--primary); align-self: flex-end; border-bottom-right-radius: 4px; color: white; }
        .chat-input-area { display: flex; gap: 12px; margin-top: 0; background: var(--bg-surface); padding: 10px; border-radius: 50px; border: 1px solid var(--border-color); box-shadow: var(--shadow-sm); }
        #chat-input { border: none; background: transparent; padding: 12px 20px; font-size: 1rem; }
        #chat-input:focus { box-shadow: none; }
        #send-chat-btn { width: 48px; height: 48px; border-radius: 50%; padding: 0; justify-content: center; background: var(--primary); color: white; border: none; }
        #send-chat-btn:hover { transform: scale(1.05); }

        /* --- Study Room --- */
        .video-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-top: 24px; }
        .video-tile { background: #000; border-radius: var(--radius-lg); overflow: hidden; aspect-ratio: 16/9; position: relative; box-shadow: var(--shadow-md); }
        video { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }
        .participant-label { position: absolute; bottom: 12px; left: 12px; background: rgba(0,0,0,0.6); color: white; padding: 6px 12px; border-radius: 20px; font-size: 0.8rem; backdrop-filter: blur(4px); }
        .controls-bar { display: flex; justify-content: center; gap: 16px; margin: 24px 0; background: var(--bg-surface); padding: 12px; border-radius: 30px; border: 1px solid var(--border-color); box-shadow: var(--shadow-sm); }
        .control-btn { width: 44px; height: 44px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.1rem; cursor: pointer; background: var(--bg-body); border: 1px solid var(--border-color); color: var(--text-secondary); transition: 0.2s; }
        .control-btn:hover { border-color: var(--primary); color: var(--primary); }
        .control-btn.active-off { background: #ffecec; border-color: #ff4d4f; color: #ff4d4f; }

        /* --- Music --- */
        .music-player { display: flex; align-items: center; gap: 24px; padding: 20px; background: var(--bg-surface); border-radius: var(--radius-lg); border: 1px solid var(--border-color); }
        .album-art { width: 64px; height: 64px; background: #ddd; border-radius: 12px; background-size: cover; background-position: center; box-shadow: var(--shadow-sm); flex-shrink: 0; }
        .track-info { flex: 1; }
        .track-title { font-weight: 700; color: var(--text-main); font-size: 1.1rem; }
        .track-artist { color: var(--text-secondary); font-size: 0.9rem; margin-top: 4px; }
        .playlist-container { margin-top: 24px; max-height: 300px; overflow-y: auto; }
        .playlist-item { display: flex; justify-content: space-between; padding: 14px 20px; border-bottom: 1px solid var(--border-color); cursor: pointer; transition: 0.2s; border-radius: var(--radius-md); }
        .playlist-item:hover { background: var(--bg-body); }

        /* --- Calendar --- */
        .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; }
        .cal-day-header { text-align: center; color: var(--text-secondary); padding-bottom: 12px; font-size: 0.85rem; font-weight: 600; text-transform: uppercase; }
        .cal-day { aspect-ratio: 1/1; background: var(--bg-surface); border-radius: var(--radius-md); padding: 10px; cursor: pointer; position: relative; transition: 0.2s; border: 1px solid var(--border-color); font-size: 0.95rem; display: flex; align-items: center; justify-content: center; }
        .cal-day:hover { border-color: var(--primary); background: var(--primary-light); color: var(--primary); }
        .cal-day.today { border: 2px solid var(--primary); color: var(--primary); font-weight: 700; }
        .cal-day.has-note { background: var(--primary-light); }
        .cal-day.has-note::after { content: ''; position: absolute; bottom: 8px; right: 8px; width: 6px; height: 6px; background: var(--accent); border-radius: 50%; }

        /* --- Modal --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 2000;
            display: flex; justify-content: center; align-items: center;
            opacity: 0; pointer-events: none; transition: opacity 0.3s;
        }
        .modal-overlay.active { opacity: 1; pointer-events: auto; }
        .modal-card {
            background: var(--bg-surface); width: 90%; max-width: 400px;
            border-radius: var(--radius-lg); padding: 32px;
            box-shadow: var(--shadow-md); border: 1px solid var(--border-color);
            transform: scale(0.9); transition: transform 0.3s;
        }
        .modal-overlay.active .modal-card { transform: scale(1); }
        .modal-header { font-size: 1.5rem; font-weight: 700; margin-bottom: 20px; color: var(--text-main); }

        /* --- Toast --- */
        #toast-container { position: fixed; bottom: 30px; right: 30px; z-index: 1000; display: flex; flex-direction: column; gap: 10px; }
        .toast { background: var(--bg-surface); border-left: 4px solid var(--primary); padding: 16px 24px; border-radius: 8px; box-shadow: var(--shadow-md); color: var(--text-main); min-width: 280px; animation: fadeIn 0.3s; display: flex; align-items: center; justify-content: space-between; font-weight: 500; border: 1px solid var(--border-color); }
        .toast.error { border-left-color: #ff4d4f; }
        .toast.success { border-left-color: #00b894; }

        /* --- Analytics --- */
        .charts-container { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; }
        .stat-card { text-align: center; padding: 24px; background: var(--bg-body); border-radius: var(--radius-lg); border: 1px solid var(--border-color); }
        .stat-val { font-size: 2.5rem; font-weight: 800; color: var(--text-main); letter-spacing: -1px; }
        .stat-label { color: var(--text-secondary); font-size: 0.9rem; font-weight: 600; text-transform: uppercase; margin-top: 8px; letter-spacing: 0.5px; }

        @media (max-width: 768px) {
            body { flex-direction: column; }
            #sidebar { display: none; } /* Hide sidebar on mobile */
            #main-content { padding: 0; padding-top: 70px; animation: none; opacity: 1; height: 100vh; }
            .user-profile-bar { flex-direction: column; gap: 12px; align-items: flex-start; }
            .section { padding: 24px; }
            .charts-container { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

    <!-- Startup Overlay (5 Seconds) -->
    <div id="startup-overlay">
        <div class="loader-ring"></div>
        <div class="loading-text">Kookie</div>
        <div class="loading-sub" id="loading-msg">Initializing...</div>
        <div class="startup-progress">
            <div class="startup-bar" id="startup-bar"></div>
        </div>
    </div>

    <!-- Navigation Sidebar -->
    <nav id="sidebar">
        <div class="logo-area">
            <i class="fas fa-cookie-bite logo-icon"></i>
            <span class="logo-text">Kookie</span>
        </div>
        <div class="nav-item active" data-target="focus">
            <i class="fas fa-clock nav-icon"></i>
            <span class="nav-label">Focus</span>
        </div>
        <div class="nav-item" data-target="analytics">
            <i class="fas fa-chart-line nav-icon"></i>
            <span class="nav-label">Analytics</span>
        </div>
        <div class="nav-item" data-target="study-room">
            <i class="fas fa-video nav-icon"></i>
            <span class="nav-label">Study Room</span>
        </div>
        <div class="nav-item" data-target="music">
            <i class="fas fa-music nav-icon"></i>
            <span class="nav-label">Music</span>
        </div>
        <div class="nav-item" data-target="calendar">
            <i class="fas fa-calendar-alt nav-icon"></i>
            <span class="nav-label">Calendar</span>
        </div>
        <div class="nav-item" data-target="chat">
            <i class="fas fa-robot nav-icon"></i>
            <span class="nav-label">AI Assistant</span>
        </div>
        <div class="nav-item" data-target="settings">
            <i class="fas fa-cog nav-icon"></i>
            <span class="nav-label">Settings</span>
        </div>
    </nav>

    <!-- Main Content Area -->
    <main id="main-content">
        <!-- User Profile Bar (New Requirement) -->
        <div class="user-profile-bar" id="user-profile-bar">
            <div class="profile-left">
                <div class="profile-avatar" id="profile-avatar" title="Click to change avatar color">JS</div>
                <div class="profile-details">
                    <div class="profile-name" id="profile-name">User Name</div>
                    <div class="profile-meta">
                        <span class="profile-tag" id="profile-class">Class/Subject</span>
                        <span class="profile-tag" id="profile-age">Age</span>
                    </div>
                    <div style="font-size: 0.8rem; color: var(--text-secondary);" id="profile-email">user@example.com</div>
                </div>
            </div>
            <div class="edit-profile-btn" id="edit-profile-btn">
                <i class="fas fa-pencil-alt"></i> Edit Profile
            </div>
        </div>

        <!-- Focus Timer Section -->
        <section id="focus" class="section active">
            <h2>Focus Timer</h2>
            <div class="card timer-container">
                <div class="timer-modes">
                    <button class="btn-secondary mode-btn active" data-time="60">Focus (60m)</button>
                    <button class="btn-secondary mode-btn" data-time="5">Short Break (5m)</button>
                    <button class="btn-secondary mode-btn" data-time="15">Long Break (15m)</button>
                </div>
                <div class="timer-display" id="time-display">60:00</div>
                <input type="text" id="task-input" placeholder="What are you working on?" style="max-width: 400px; margin-bottom: 24px; text-align: center; font-weight: 500;">
                <div class="progress-bar-bg">
                    <div class="progress-bar-fill" id="timer-progress"></div>
                </div>
                <div style="margin-top: 32px; display: flex; gap: 16px; justify-content: center;">
                    <button id="start-timer-btn" class="btn-primary" style="padding: 12px 32px; font-size: 1rem;"><i class="fas fa-play"></i> Start Session</button>
                    <button id="pause-timer-btn" class="btn-secondary"><i class="fas fa-pause"></i> Pause</button>
                    <button id="reset-timer-btn" class="btn-secondary"><i class="fas fa-redo"></i> Reset</button>
                </div>
            </div>
        </section>

        <!-- Analytics Section -->
        <section id="analytics" class="section">
            <h2>Productivity Analytics</h2>
            <div class="charts-container">
                <div class="card">
                    <h3 style="margin-top:0; font-size:1.1rem; color:var(--text-secondary);">Weekly Focus</h3>
                    <canvas id="weeklyChart"></canvas>
                </div>
                <div class="card">
                    <h3 style="margin-top:0; font-size:1.1rem; color:var(--text-secondary);">Session Distribution</h3>
                    <canvas id="typeChart"></canvas>
                </div>
            </div>
            <div class="card" style="display: flex; gap: 20px; justify-content: space-around;">
                <div class="stat-card">
                    <div class="stat-val" id="stat-total-time">0</div>
                    <div class="stat-label">Total Minutes</div>
                </div>
                <div class="stat-card">
                    <div class="stat-val" id="stat-sessions">0</div>
                    <div class="stat-label">Sessions Completed</div>
                </div>
            </div>
            <button id="refresh-analytics" class="btn-secondary"><i class="fas fa-sync"></i> Refresh Metrics</button>
        </section>

        <!-- Study Room Section -->
        <section id="study-room" class="section">
            <h2>Study Room</h2>
            
            <!-- Unique Link Card -->
            <div class="card" id="unique-link-card" style="display:none; border: 2px solid var(--primary);">
                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
                    <h3 style="margin: 0; color: var(--primary);">Room Invite Link</h3>
                    <button class="btn-secondary" id="close-link-card" style="padding: 4px 8px; font-size: 0.8rem;"><i class="fas fa-times"></i></button>
                </div>
                <p style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 15px;">Share this link with your friends to join your study room:</p>
                <div style="display: flex; gap: 10px;">
                    <input type="text" id="room-link-display" readonly style="flex: 1; background: var(--bg-body); border: 1px solid var(--border-color); font-weight: 500; color: var(--text-main); padding: 12px; border-radius: var(--radius-md);">
                    <button id="copy-link-btn" class="btn-primary"><i class="fas fa-copy"></i> Copy Link</button>
                </div>
            </div>

            <div class="card">
                <div id="room-lobby" style="text-align: center;">
                    <p style="color:var(--text-secondary); margin-bottom:24px;">
                        Create a room to generate a unique link. <br>
                        <span style="font-size: 0.85rem; opacity: 0.8;">(Permissions required: Camera & Microphone)</span>
                    </p>
                    
                    <div style="margin: 20px 0; display: flex; flex-direction: column; align-items: center; gap: 15px;">
                        <input type="text" id="room-id-input" placeholder="Paste Room ID to join..." style="max-width: 300px; text-align: center;">
                        
                        <div style="display: flex; gap: 10px;">
                            <button id="create-room-btn" class="btn-primary" style="min-width: 180px; justify-content: center;"><i class="fas fa-video"></i> Create New Room</button>
                            <button id="join-room-btn" class="btn-secondary" style="min-width: 180px; justify-content: center;"><i class="fas fa-sign-in-alt"></i> Join Room</button>
                        </div>
                    </div>
                </div>

                <div id="active-room" style="display: none;">
                    <div class="controls-bar">
                        <div class="control-btn" id="toggle-mic" title="Toggle Mic"><i class="fas fa-microphone"></i></div>
                        <div class="control-btn" id="toggle-cam" title="Toggle Cam"><i class="fas fa-video"></i></div>
                        <div class="control-btn" id="share-screen" title="Share Screen"><i class="fas fa-desktop"></i></div>
                        <button id="leave-room-btn" class="btn-danger" style="border-radius: 20px; padding: 0 20px;">Leave Room</button>
                    </div>
                    <div class="video-grid" id="video-grid">
                        <div class="video-tile" id="local-video-tile">
                            <video id="local-video" autoplay muted playsinline></video>
                            <div class="participant-label">You</div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Music Section -->
        <section id="music" class="section">
            <h2>Focus Music</h2>
            <div class="card music-player">
                <div class="album-art" id="album-art"></div>
                <div class="track-info">
                    <div class="track-title" id="track-title">Select a track</div>
                    <div class="track-artist" id="track-artist">--</div>
                </div>
                <div class="music-controls">
                    <button class="btn-secondary" id="prev-btn"><i class="fas fa-step-backward"></i></button>
                    <button class="btn-primary" id="play-pause-btn" style="width: 48px; height: 48px; justify-content: center; border-radius: 50%;"><i class="fas fa-play"></i></button>
                    <button class="btn-secondary" id="next-btn"><i class="fas fa-step-forward"></i></button>
                </div>
                <input type="range" id="volume-slider" min="0" max="1" step="0.1" value="0.5" style="width: 100px;">
            </div>
            <div class="card">
                <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                    <input type="text" id="external-playlist-url" placeholder="Paste audio URL to add to queue">
                    <button id="import-track-btn" class="btn-secondary">Import</button>
                    <button id="load-demo-btn" class="btn-secondary">Load Demo Playlist</button>
                </div>
                <h3 style="font-size: 1rem; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 1px;">Playlist</h3>
                <div class="playlist-container" id="playlist-container"></div>
            </div>
        </section>

        <!-- Calendar Section -->
        <section id="calendar" class="section">
            <h2>Calendar & Notes</h2>
            <div class="card">
                <div class="calendar-header">
                    <button class="btn-secondary" id="prev-month"><i class="fas fa-chevron-left"></i></button>
                    <h3 id="current-month-display" style="margin:0; font-weight:700;">Month Year</h3>
                    <button class="btn-secondary" id="next-month"><i class="fas fa-chevron-right"></i></button>
                </div>
                <div class="calendar-grid">
                    <div class="cal-day-header">Sun</div><div class="cal-day-header">Mon</div><div class="cal-day-header">Tue</div><div class="cal-day-header">Wed</div><div class="cal-day-header">Thu</div><div class="cal-day-header">Fri</div><div class="cal-day-header">Sat</div>
                </div>
                <div class="calendar-grid" id="calendar-days"></div>
            </div>
            <div class="card" id="note-editor" style="display:none; border: 2px solid var(--primary);">
                <h3>Edit Note: <span id="note-date-display" style="font-weight:400; color:var(--text-secondary);"></span></h3>
                <input type="text" id="note-title" placeholder="Title" style="margin-bottom:12px;">
                <textarea id="note-content" rows="4" placeholder="Note details..." style="margin-bottom: 16px;"></textarea>
                <div style="display: flex; gap: 10px;">
                    <button id="save-note-btn" class="btn-primary">Save Note</button>
                    <button id="delete-note-btn" class="btn-danger">Delete</button>
                    <button id="cancel-note-btn" class="btn-secondary">Cancel</button>
                </div>
            </div>
        </section>

        <!-- Chat Section -->
        <section id="chat" class="section">
            <h2>Kookie AI Assistant</h2>
            <div class="card chat-layout">
                <div class="chat-history" id="chat-history">
                    <div class="message msg-ai">Hi there! I'm Kookie. ðŸ‘‹ I'm here to help you stay motivated. How are you feeling today?</div>
                </div>
                <div class="chat-input-area">
                    <input type="text" id="chat-input" placeholder="Type a message..." autocomplete="off">
                    <button id="send-chat-btn" class="btn-primary"><i class="fas fa-paper-plane"></i></button>
                </div>
            </div>
        </section>

        <!-- Settings Section -->
        <section id="settings" class="section">
            <h2>Settings</h2>
            <div class="card">
                <div style="margin-bottom: 24px;">
                    <label style="display:block; margin-bottom:8px; font-weight:600;">Theme Preference</label>
                    <select id="theme-select">
                        <option value="kookie">Kookie Light (Default)</option>
                        <option value="dark">Deep Dark Mode</option>
                    </select>
                </div>

                <div style="border-top: 1px solid var(--border-color); margin: 24px 0;"></div>

                <div style="margin-bottom: 24px;">
                    <label style="display:block; margin-bottom:8px; font-weight:600;">Notifications</label>
                    <div style="margin-bottom: 12px;">
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="checkbox" id="notif-enabled" checked style="width: auto;"> <span>Enable Notifications</span>
                        </label>
                    </div>
                    <div>
                        <label style="display:block; margin-bottom:8px; font-size:0.9rem; color:var(--text-secondary);">Notification Tone</label>
                        <select id="notif-tone">
                            <option value="whistle" selected>Whistle</option>
                            <option value="chime">Chime</option>
                            <option value="mute">Mute</option>
                        </select>
                    </div>
                </div>

                <div style="border-top: 1px solid var(--border-color); margin: 24px 0;"></div>

                <div style="margin-bottom: 24px;">
                    <label style="display:block; margin-bottom:8px; font-weight:600;">Study Room Devices</label>
                    <div style="margin-bottom: 16px;">
                        <label style="display:block; margin-bottom:8px; font-size:0.9rem; color:var(--text-secondary);">Camera</label>
                        <select id="camera-select">
                            <option value="">Default Camera</option>
                        </select>
                    </div>
                    <div>
                        <label style="display:block; margin-bottom:8px; font-size:0.9rem; color:var(--text-secondary);">Microphone</label>
                        <select id="mic-select">
                            <option value="">Default Microphone</option>
                        </select>
                    </div>
                    <p style="font-size:0.8rem; color:var(--text-secondary); margin-top:10px;">
                        <i class="fas fa-info-circle"></i> Refresh page after changing devices to apply them in Study Room.
                    </p>
                </div>

                <button id="save-settings-btn" class="btn-primary">Save Settings</button>
            </div>
            <div class="card" style="border-left: 4px solid #ff4d4f;">
                <h3 style="color:#ff4d4f;">Data Management</h3>
                <p style="color:var(--text-secondary); margin-bottom: 16px;">Clear all local data and reset backend simulation.</p>
                <button id="reset-app-btn" class="btn-danger">Reset Application</button>
            </div>
        </section>
    </main>

    <!-- Edit Profile Modal (Hidden by default) -->
    <div class="modal-overlay" id="profile-modal-overlay">
        <div class="modal-card">
            <div class="modal-header">Edit Profile</div>
            <div style="display: flex; flex-direction: column; gap: 15px;">
                <div>
                    <label style="display:block; margin-bottom: 6px; font-size: 0.85rem; color: var(--text-secondary);">Name</label>
                    <input type="text" id="edit-name" placeholder="Your Name">
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <div>
                        <label style="display:block; margin-bottom: 6px; font-size: 0.85rem; color: var(--text-secondary);">Class / Subject</label>
                        <input type="text" id="edit-class" placeholder="e.g. Science">
                    </div>
                    <div>
                        <label style="display:block; margin-bottom: 6px; font-size: 0.85rem; color: var(--text-secondary);">Age</label>
                        <input type="number" id="edit-age" placeholder="e.g. 20">
                    </div>
                </div>
                <div>
                    <label style="display:block; margin-bottom: 6px; font-size: 0.85rem; color: var(--text-secondary);">Email</label>
                    <input type="email" id="edit-email" placeholder="email@example.com">
                </div>
            </div>
            <div style="margin-top: 20px; display: flex; justify-content: flex-end; gap: 10px;">
                <button class="btn-secondary" id="cancel-profile-edit">Cancel</button>
                <button class="btn-primary" id="save-profile-edit">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toast-container"></div>

    <script>
        // --- Utils ---
        const $ = (s) => document.querySelector(s);
        const $$ = (s) => document.querySelectorAll(s);
        
        const showToast = (msg, type = 'info') => {
            const container = $('#toast-container');
            const el = document.createElement('div');
            el.className = `toast ${type}`;
            el.innerHTML = `<span>${msg}</span> <i class="fas fa-times" onclick="this.parentElement.remove()" style="cursor:pointer; color:var(--text-light);"></i>`;
            container.appendChild(el);
            setTimeout(() => el.remove(), 4000);
        };

        const setBtnLoading = (btn, isLoading) => {
            if (isLoading) {
                btn.dataset.originalText = btn.innerHTML;
                btn.classList.add('btn-loading');
                btn.disabled = true;
            } else {
                btn.classList.remove('btn-loading');
                btn.innerHTML = btn.dataset.originalText || btn.innerHTML;
                btn.disabled = false;
            }
        };

        // --- Audio Helper (Whistle) ---
        const playWhistle = () => {
            try {
                const ctx = new (window.AudioContext || window.webkitAudioContext)();
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                
                osc.connect(gain);
                gain.connect(ctx.destination);
                
                // Whistle Simulation: Sine wave rising rapidly
                osc.type = 'sine';
                osc.frequency.setValueAtTime(1500, ctx.currentTime);
                osc.frequency.linearRampToValueAtTime(2500, ctx.currentTime + 0.1);
                osc.frequency.exponentialRampToValueAtTime(1000, ctx.currentTime + 0.4);

                gain.gain.setValueAtTime(0.1, ctx.currentTime);
                gain.gain.linearRampToValueAtTime(0, ctx.currentTime + 0.5);

                osc.start();
                osc.stop(ctx.currentTime + 0.5);
            } catch(e) {
                console.warn("Audio not supported or blocked", e);
            }
        };

        const playChime = () => {
            try {
                const ctx = new (window.AudioContext || window.webkitAudioContext)();
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                
                osc.connect(gain);
                gain.connect(ctx.destination);
                
                osc.type = 'triangle';
                osc.frequency.setValueAtTime(800, ctx.currentTime);
                
                gain.gain.setValueAtTime(0.1, ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.6);

                osc.start();
                osc.stop(ctx.currentTime + 0.6);
            } catch(e) {
                console.warn("Audio not supported", e);
            }
        };

        const playNotificationSound = () => {
            const settings = backend.getSettings();
            if(!settings.notifEnabled) return;
            
            if(settings.notifTone === 'whistle') playWhistle();
            else if(settings.notifTone === 'chime') playChime();
        };

        // --- Backend Actor System (Simulated) ---
        class BackendActor {
            constructor() {
                this.isReady = false;
                try {
                    const saved = JSON.parse(localStorage.getItem('kookie_db')) || {};
                    this.store = {
                        sessions: saved.sessions || [], 
                        chatHistory: saved.chatHistory || [], 
                        playlist: saved.playlist || [], 
                        notes: saved.notes || {}, 
                        settings: saved.settings || { 
                            theme: 'kookie', 
                            sound: true, 
                            notifEnabled: true,
                            notifTone: 'whistle',
                            videoId: '',
                            audioId: '',
                            // User Profile Data
                            name: 'Student',
                            age: 20,
                            email: '',
                            subject: 'General Studies',
                            avatarColor: '#764ba2'
                        }
                    };
                } catch(e) {
                    this.store = { sessions: [], chatHistory: [], playlist: [], notes: {}, settings: { theme: 'kookie', sound: true, notifEnabled: true, notifTone: 'whistle', videoId: '', audioId: '', name: 'Student', age: 20, email: '', subject: 'General Studies', avatarColor: '#764ba2' } };
                }
            }

            init() {
                return new Promise((resolve) => {
                    const duration = 5000; 
                    const intervalTime = 50; 
                    let elapsed = 0;
                    const steps = ["Initializing Core Engine...", "Loading User Profile...", "Syncing Productivity Data...", "Configuring AI Assistant...", "Finalizing Workspace..."];

                    const timer = setInterval(() => {
                        elapsed += intervalTime;
                        const progress = Math.min(100, Math.floor((elapsed / duration) * 100));
                        
                        // Update Progress Bar
                        $('#startup-bar').style.width = `${progress}%`;
                        
                        // Update Text based on progress thresholds
                        const stepIndex = Math.min(steps.length - 1, Math.floor((elapsed / duration) * steps.length));
                        if ($('#loading-msg').innerText !== steps[stepIndex]) {
                            $('#loading-msg').innerText = steps[stepIndex];
                        }

                        if (elapsed >= duration) {
                            clearInterval(timer);
                            this.isReady = true;
                            resolve(true);
                        }
                    }, intervalTime);
                });
            }

            _persist() { try { localStorage.setItem('kookie_db', JSON.stringify(this.store)); } catch(e) {} }
            async addSession(data) { if (!this.isReady) throw new Error("Actor not ready"); this.store.sessions.push(data); this._persist(); return true; }
            async getSessions() { if (!this.isReady) throw new Error("Actor not ready"); return this.store.sessions; }
            async addMessage(msg) { if (!this.isReady) throw new Error("Actor not ready"); this.store.chatHistory.push(msg); this._persist(); }
            async getChatHistory() { if (!this.isReady) throw new Error("Actor not ready"); return this.store.chatHistory; }
            async updatePlaylist(tracks) { if (!this.isReady) throw new Error("Actor not ready"); this.store.playlist = tracks; this._persist(); }
            async getPlaylist() { if (!this.isReady) throw new Error("Actor not ready"); return this.store.playlist; }
            async saveNote(date, note) { if (!this.isReady) throw new Error("Actor not ready"); if(!note.title && !note.content) delete this.store.notes[date]; else this.store.notes[date] = note; this._persist(); }
            async getNotes() { if (!this.isReady) throw new Error("Actor not ready"); return this.store.notes; }
            async saveSettings(settings) { if (!this.isReady) throw new Error("Actor not ready"); this.store.settings = { ...this.store.settings, ...settings }; this._persist(); }
            async saveProfile(profile) { if (!this.isReady) throw new Error("Actor not ready"); this.store.settings = { ...this.store.settings, ...profile }; this._persist(); }
            getSettings() { return this.store.settings; }
            async reset() { this.store = { sessions: [], chatHistory: [], playlist: [], notes: [], settings: { theme: 'kookie', sound: true, notifEnabled: true, notifTone: 'whistle', videoId: '', audioId: '', name: 'Student', age: 20, email: '', subject: 'General Studies', avatarColor: '#764ba2' } }; this._persist(); }
        }

        const backend = new BackendActor();

        // --- UI Controller Logic ---

        //1. Initialization
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                await backend.init();
                const overlay = $('#startup-overlay');
                overlay.style.opacity = '0';
                
                setTimeout(() => {
                    overlay.style.display = 'none';
                    $$('.backend-dependent').forEach(btn => { if(!btn.classList.contains('control-btn')) btn.disabled = false; });
                    showToast("Workspace Ready", "success");

                    TimerModule.load();
                    ChatModule.loadHistory();
                    MusicModule.loadPlaylist();
                    CalendarModule.render();
                    AnalyticsModule.render();
                    SettingsModule.load();
                    SettingsModule.applyTheme(backend.getSettings().theme);
                    ProfileModule.render(); // New Profile Module

                    // Setup Focus Lost Listener
                    window.onblur = () => {
                        if(TimerModule.isRunning) {
                            playNotificationSound();
                            showToast("Focus Lost! Timer is still running.", "info");
                        }
                    };
                }, 800); 
            } catch (e) {
                console.error(e);
                $('#loading-msg').innerText = "Error Loading App";
                $('#loading-msg').style.color = "red";
            }
        });

        // Global Button Guard
        document.addEventListener('click', (e) => {
            const btn = e.target.closest('button');
            if (btn && !btn.classList.contains('skip-guard')) {
                if (!backend.isReady) {
                    e.preventDefault();
                    e.stopPropagation();
                    showToast("App is starting... please wait.", "error");
                }
            }
        });

        // 2. Navigation
        $$('.nav-item').forEach(item => {
            item.addEventListener('click', () => {
                $$('.nav-item').forEach(n => n.classList.remove('active'));
                item.classList.add('active');
                const target = item.dataset.target;
                $$('.section').forEach(s => s.classList.remove('active'));
                $(`#${target}`).classList.add('active');
            });
        });

        // 3. Timer Module
        const TimerModule = {
            time: 60 * 60, initialTime: 60 * 60, interval: null, isRunning: false,
            init() {
                $('#start-timer-btn').addEventListener('click', () => this.start());
                $('#pause-timer-btn').addEventListener('click', () => this.pause());
                $('#reset-timer-btn').addEventListener('click', () => this.reset());
                $$('.mode-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        $$('.mode-btn').forEach(b => b.classList.remove('active'));
                        e.target.closest('button').classList.add('active');
                        this.setMode(parseInt(e.target.closest('button').dataset.time));
                    });
                });
            },
            setMode(mins) { this.pause(); this.initialTime = mins * 60; this.time = this.initialTime; this.updateDisplay(); this.updateProgress(); },
            updateDisplay() { const m = Math.floor(this.time / 60).toString().padStart(2, '0'); const s = (this.time % 60).toString().padStart(2, '0'); $('#time-display').innerText = `${m}:${s}`; document.title = `${m}:${s} - Kookie Focus`; },
            updateProgress() { const pct = ((this.initialTime - this.time) / this.initialTime) * 100; $('#timer-progress').style.width = `${100 - pct}%`; },
            async start() {
                if (this.isRunning) return;
                const btn = $('#start-timer-btn');
                setBtnLoading(btn, true);
                try {
                    await new Promise(r => setTimeout(r, 500));
                    if(!backend.isReady) throw new Error("Backend offline");
                    this.isRunning = true;
                    setBtnLoading(btn, false);
                    this.interval = setInterval(() => {
                        this.time--; this.updateDisplay(); this.updateProgress();
                        if (this.time <= 0) this.complete();
                    }, 1000);
                    playNotificationSound(); // Play Whistle on Start
                } catch (e) { setBtnLoading(btn, false); showToast("Could not start session: " + e.message, "error"); }
            },
            pause() { clearInterval(this.interval); this.isRunning = false; },
            reset() { this.pause(); this.time = this.initialTime; this.updateDisplay(); this.updateProgress(); },
            async complete() {
                this.pause();
                playNotificationSound(); // Play Whistle on Finish
                await backend.addSession({ date: new Date().toISOString(), duration: this.initialTime / 60, task: $('#task-input').value || "Untitled Session", type: this.initialTime === 60*60 ? 'focus' : 'break' });
                showToast("Session Complete!", "success");
                AnalyticsModule.render();
                this.reset();
            },
            load() { this.updateDisplay(); } 
        };
        TimerModule.init();

        // 4. Chat Module
        const ChatModule = {
            async loadHistory() { const history = await backend.getChatHistory(); history.forEach(msg => this.appendMessage(msg.role, msg.content, false)); },
            appendMessage(role, content, save = true) {
                const div = document.createElement('div'); div.className = `message ${role === 'user' ? 'msg-user' : 'msg-ai'}`; div.innerText = content;
                $('#chat-history').appendChild(div); $('#chat-history').scrollTop = $('#chat-history').scrollHeight;
                if (save) backend.addMessage({ role, content, date: new Date() });
            },
            async processAI(text) {
                await new Promise(r => setTimeout(r, 1000 + Math.random() * 1000));
                const lower = text.toLowerCase();
                let response = "";
                
                if (lower.includes("tired") || lower.includes("sleepy")) {
                    response = "I hear you. Rest is important too. Would you like to set a timer for a 20-minute power nap?";
                } else if (lower.includes("stressed") || lower.includes("anxious")) {
                    response = "Take a deep breath. In for 4, hold for 4, out for 4. You're doing great by just being here.";
                } else if (lower.includes("timer") || lower.includes("pomodoro")) {
                    response = "I can help with that! Go to Focus tab, set your time, and I'll cheer you on.";
                } else if (lower.includes("hello") || lower.includes("hi")) {
                    response = "Hello! Ready to be productive today? I'm here if you need motivation.";
                } else if (lower.includes("sad") || lower.includes("bad")) {
                    response = "I'm sorry you're feeling down. Maybe some calming music from Music tab would help?";
                } else if (lower.includes("thank")) {
                    response = "You're welcome! Keep up the good work.";
                } else {
                    const generics = [
                        "Interesting thought. How does that relate to your goals?",
                        "I'm listening. Tell me more.",
                        "That's noted. Is there anything specific I can do to help?",
                        "Sounds like a plan. I believe in you!"
                    ];
                    response = generics[Math.floor(Math.random() * generics.length)];
                }
                this.appendMessage('ai', response);
            }
        };
        $('#send-chat-btn').addEventListener('click', () => {
            const input = $('#chat-input'); const text = input.value.trim();
            if (!text) return;
            setBtnLoading($('#send-chat-btn'), true);
            ChatModule.appendMessage('user', text); input.value = "";
            setBtnLoading($('#send-chat-btn'), false);
            ChatModule.processAI(text);
        });
        $('#chat-input').addEventListener('keypress', (e) => { if(e.key === 'Enter') $('#send-chat-btn').click(); });

        // 5. Profile Module (New)
        const ProfileModule = {
            init() {
                $('#edit-profile-btn').addEventListener('click', () => this.openModal());
                $('#cancel-profile-edit').addEventListener('click', () => this.closeModal());
                $('#save-profile-edit').addEventListener('click', () => this.save());
                $('#profile-avatar').addEventListener('click', () => this.randomizeAvatarColor());
            },
            render() {
                const settings = backend.getSettings();
                $('#profile-name').innerText = settings.name || "User";
                $('#profile-email').innerText = settings.email || "";
                $('#profile-class').innerText = settings.subject || "Class/Subject";
                $('#profile-age').innerText = settings.age ? `${settings.age} yrs` : "";
                $('#profile-avatar').innerText = settings.name ? settings.name.charAt(0).toUpperCase() : "U";
                $('#profile-avatar').style.backgroundColor = settings.avatarColor;
            },
            openModal() {
                const settings = backend.getSettings();
                $('#edit-name').value = settings.name;
                $('#edit-email').value = settings.email;
                $('#edit-class').value = settings.subject;
                $('#edit-age').value = settings.age;
                $('#profile-modal-overlay').classList.add('active');
            },
            closeModal() {
                $('#profile-modal-overlay').classList.remove('active');
            },
            randomizeAvatarColor() {
                const randomColor = '#' + Math.floor(Math.random()*16777215).toString(16);
                this.save({ avatarColor: randomColor });
            },
            async save() {
                const name = $('#edit-name').value.trim();
                const email = $('#edit-email').value.trim();
                const subject = $('#edit-class').value.trim();
                const age = $('#edit-age').value;

                if(!name) return showToast("Name is required!", "error");

                await backend.saveProfile({ name, email, subject, age });
                this.render();
                this.closeModal();
                showToast("Profile updated!", "success");
            }
        };
        ProfileModule.init();

        // 6. Study Room (Refined & Reliable)
        const StudyRoom = {
            peer: null, conn: null, currentStream: null, currentRoomId: null,
            init() {
                // Check URL parameters for Room ID automatically
                const params = new URLSearchParams(window.location.search);
                const roomIdFromUrl = params.get('room');
                if (roomIdFromUrl) {
                    $('#room-id-input').value = roomIdFromUrl;
                    showToast("Room ID detected from link! Click Join.", "info");
                }

                $('#create-room-btn').addEventListener('click', () => this.createRoom());
                $('#join-room-btn').addEventListener('click', () => this.joinRoom());
                $('#leave-room-btn').addEventListener('click', () => this.leaveRoom());
                $('#toggle-mic').addEventListener('click', (e) => this.toggleTrack('audio', e.currentTarget));
                $('#toggle-cam').addEventListener('click', (e) => this.toggleTrack('video', e.currentTarget));
                $('#close-link-card').addEventListener('click', () => this.hideUniqueLinkCard());
                $('#copy-link-btn').addEventListener('click', () => {
                   const copyText = document.getElementById("room-link-display"); copyText.select(); navigator.clipboard.writeText(copyText.value); showToast("Link copied!", "success");
                });
            },
            async getMedia() { 
                try {
                    const settings = backend.getSettings();
                    const constraints = { video: true, audio: true };
                    if(settings.videoId) constraints.video = { deviceId: { exact: settings.videoId } };
                    if(settings.audioId) constraints.audio = { deviceId: { exact: settings.audioId } };

                    const stream = await navigator.mediaDevices.getUserMedia(constraints); 
                    this.currentStream = stream; $('#local-video').srcObject = stream; 
                    return stream; 
                } catch (err) { 
                    console.error(err);
                    showToast("Camera/Mic permission denied or device busy.", "error"); 
                    throw err; 
                } 
            },
            async createRoom() { 
                if(!backend.isReady) return; 
                
                // 1. Cleanup previous connection if it exists
                if(this.peer) this.leaveRoom(false); 

                setBtnLoading($('#create-room-btn'), true); 
                try { 
                    await this.getMedia(); 
                    
                    // 2. Create Peer with null ID (Generates a brand new random ID every time)
                    this.peer = new Peer(null, { debug: 0 }); // debug 0 for cleaner console
                    
                    this.peer.on('open', (id) => { 
                        this.currentRoomId = id;
                        
                        // 3. Show Invite Link Card
                        this.showUniqueLinkCard(id);
                        
                        // 4. Switch to Active Room View
                        $('#room-lobby').style.display = 'none'; 
                        $('#active-room').style.display = 'block'; 
                        
                        showToast("Room created successfully.", "success"); 
                    }); 
                    
                    // 5. Handle incoming calls from other peers
                    this.peer.on('call', (call) => { 
                        call.answer(this.currentStream); 
                        const vid = document.createElement('div'); 
                        vid.className = 'video-tile'; 
                        vid.innerHTML = `<video autoplay playsinline></video><div class="participant-label">Peer</div>`; 
                        call.on('stream', (remoteStream) => { vid.querySelector('video').srcObject = remoteStream; }); 
                        $('#video-grid').appendChild(vid); 
                    }); 
                    
                    this.peer.on('error', (err) => {
                        console.error("Peer Error", err);
                        showToast("Connection error: " + err.type, "error");
                        this.leaveRoom();
                    });

                } catch (e) { 
                    console.error(e); 
                    showToast("Failed to create room.", "error"); 
                } finally { 
                    setBtnLoading($('#create-room-btn'), false); 
                } 
            },
            async joinRoom() { 
                const roomId = $('#room-id-input').value.trim(); 
                if(!roomId) return showToast("Enter a Room ID", "error"); 
                
                setBtnLoading($('#join-room-btn'), true); 
                try { 
                    await this.getMedia(); 
                    this.peer = new Peer(); 
                    
                    this.peer.on('open', (myId) => {
                        const conn = this.peer.connect(roomId); 
                        
                        conn.on('open', () => { 
                            this.conn = conn;
                            // Now call the host with video/audio
                            const call = this.peer.call(roomId, this.currentStream); 
                            
                            const vid = document.createElement('div'); 
                            vid.className = 'video-tile'; 
                            vid.innerHTML = `<video autoplay playsinline></video><div class="participant-label">Peer</div>`; 
                            $('#video-grid').appendChild(vid); 
                            
                            call.on('stream', (remoteStream) => { vid.querySelector('video').srcObject = remoteStream; }); 
                            
                            $('#room-lobby').style.display = 'none'; 
                            $('#active-room').style.display = 'block'; 
                            showToast("Joined room!", "success"); 
                        });

                        conn.on('error', (err) => {
                            console.error("Connection error", err);
                            showToast("Could not connect to peer. ID might be invalid.", "error");
                            this.leaveRoom(false);
                        });
                    });

                    this.peer.on('error', (err) => {
                        console.error("Peer error", err);
                        showToast("Peer connection failed.", "error");
                        this.leaveRoom(false);
                    });

                } catch(e) { 
                    showToast("Connection failed.", "error"); 
                } finally { 
                    setBtnLoading($('#join-room-btn'), false); 
                } 
            },
            leaveRoom(showToastMsg = true) { 
                if(this.currentStream) this.currentStream.getTracks().forEach(track => track.stop()); 
                if(this.peer) this.peer.destroy(); 
                
                // Reset UI State
                $('#active-room').style.display = 'none'; 
                $('#room-lobby').style.display = 'block'; 
                this.hideUniqueLinkCard();
                
                // Clean Video Grid
                $('#video-grid').innerHTML = `<div class="video-tile" id="local-video-tile"><video id="local-video" autoplay muted playsinline></video><div class="participant-label">You</div></div>`;
                
                this.currentRoomId = null;
                
                if(showToastMsg) showToast("Left room", "info");
            },
            showUniqueLinkCard(roomId) {
                const baseUrl = window.location.protocol + "//" + window.location.host + window.location.pathname;
                $('#room-link-display').value = `${baseUrl}?room=${roomId}`; 
                $('#unique-link-card').style.display = 'block';
            },
            hideUniqueLinkCard() {
                $('#unique-link-card').style.display = 'none';
            },
            toggleTrack(type, btn) { 
                if(!this.currentStream) return; 
                const track = type === 'audio' ? this.currentStream.getAudioTracks()[0] : this.currentStream.getVideoTracks()[0]; 
                if(track) { 
                    track.enabled = !track.enabled; 
                    btn.classList.toggle('active-off'); 
                    btn.querySelector('i').className = track.enabled ? (type === 'audio' ? 'fas fa-microphone' : 'fas fa-video') : (type === 'audio' ? 'fas fa-microphone-slash' : 'fas fa-video-slash'); 
                } 
            }
        };
        StudyRoom.init();

        // 7. Music
        const MusicModule = {
            audio: new Audio(), playlist: [], currentIndex: 0, isPlaying: false,
            init() { $('#play-pause-btn').addEventListener('click', () => this.togglePlay()); $('#next-btn').addEventListener('click', () => this.next()); $('#prev-btn').addEventListener('click', () => this.prev()); $('#volume-slider').addEventListener('input', (e) => this.audio.volume = e.target.value); $('#import-track-btn').addEventListener('click', () => this.importTrack()); $('#load-demo-btn').addEventListener('click', () => this.loadDemoPlaylist()); this.audio.addEventListener('ended', () => this.next()); },
            async loadPlaylist() { this.playlist = await backend.getPlaylist(); this.renderPlaylist(); if(this.playlist.length > 0) this.loadTrack(0, false); },
            renderPlaylist() { const container = $('#playlist-container'); container.innerHTML = ''; this.playlist.forEach((track, idx) => { const div = document.createElement('div'); div.className = 'playlist-item'; div.innerHTML = `<span>${track.title} - ${track.artist}</span><i class="fas fa-play" style="font-size:0.8rem; color:var(--text-secondary)"></i>`; div.onclick = () => this.loadTrack(idx, true); container.appendChild(div); }); },
            loadTrack(index, autoPlay) { this.currentIndex = index; const track = this.playlist[index]; this.audio.src = track.url; $('#track-title').innerText = track.title; $('#track-artist').innerText = track.artist; $('#album-art').style.backgroundImage = `linear-gradient(${Math.floor(Math.random() * 360)}deg, #eee, #ddd)`; if(autoPlay) this.play(); },
            togglePlay() { if(this.isPlaying) this.pause(); else this.play(); },
            play() { if(this.playlist.length === 0) return showToast("Playlist is empty", "error"); this.audio.play(); this.isPlaying = true; $('#play-pause-btn').innerHTML = '<i class="fas fa-pause"></i>'; },
            pause() { this.audio.pause(); this.isPlaying = false; $('#play-pause-btn').innerHTML = '<i class="fas fa-play"></i>'; },
            next() { let nextIdx = (this.currentIndex + 1) % this.playlist.length; this.loadTrack(nextIdx, true); },
            prev() { let prevIdx = (this.currentIndex - 1 + this.playlist.length) % this.playlist.length; this.loadTrack(prevIdx, true); },
            async importTrack() { const url = $('#external-playlist-url').value.trim(); const title = prompt("Track Title:", "Imported Track"); if(url && title) { this.playlist.push({ title, artist: "External", url }); await backend.updatePlaylist(this.playlist); this.renderPlaylist(); $('#external-playlist-url').value = ""; showToast("Track imported", "success"); } },
            async loadDemoPlaylist() { const demoTracks = [{ title: "Focus Flow", artist: "Kookie Demo", url: "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3" }, { title: "Deep Work", artist: "Kookie Demo", url: "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-8.mp3" }, { title: "Lo-Fi Beats", artist: "Kookie Demo", url: "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-3.mp3" }]; this.playlist = demoTracks; await backend.updatePlaylist(this.playlist); this.renderPlaylist(); this.loadTrack(0, false); showToast("Demo playlist loaded", "success"); }
        };
        MusicModule.init();

        // 8. Calendar
        const CalendarModule = {
            currentDate: new Date(), selectedDate: null,
            init() { $('#prev-month').addEventListener('click', () => this.changeMonth(-1)); $('#next-month').addEventListener('click', () => this.changeMonth(1)); $('#save-note-btn').addEventListener('click', () => this.saveNote()); $('#cancel-note-btn').addEventListener('click', () => this.closeNoteEditor()); $('#delete-note-btn').addEventListener('click', () => this.deleteNote()); },
            async render() { const year = this.currentDate.getFullYear(); const month = this.currentDate.getMonth(); $('#current-month-display').innerText = new Date(year, month).toLocaleString('default', { month: 'long', year: 'numeric' }); const firstDay = new Date(year, month, 1).getDay(); const daysInMonth = new Date(year, month + 1, 0).getDate(); const grid = $('#calendar-days'); grid.innerHTML = ''; const notes = await backend.getNotes(); for(let i=0; i<firstDay; i++) grid.innerHTML += `<div></div>`; for(let d=1; d<=daysInMonth; d++) { const dateStr = `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`; const el = document.createElement('div'); el.className = 'cal-day'; el.innerText = d; if(new Date().toISOString().startsWith(dateStr)) el.classList.add('today'); if(notes[dateStr]) el.classList.add('has-note'); el.addEventListener('click', () => this.openNoteEditor(dateStr, notes[dateStr])); grid.appendChild(el); } },
            changeMonth(delta) { this.currentDate.setMonth(this.currentDate.getMonth() + delta); this.render(); },
            openNoteEditor(dateStr, noteData) { this.selectedDate = dateStr; $('#note-date-display').innerText = dateStr; $('#note-title').value = noteData ? noteData.title : ''; $('#note-content').value = noteData ? noteData.content : ''; $('#note-editor').style.display = 'block'; $('#note-editor').scrollIntoView({ behavior: 'smooth' }); },
            closeNoteEditor() { $('#note-editor').style.display = 'none'; this.selectedDate = null; },
            async saveNote() { if(!this.selectedDate) return; const note = { title: $('#note-title').value, content: $('#note-content').value }; await backend.saveNote(this.selectedDate, note); showToast("Note saved", "success"); this.render(); this.closeNoteEditor(); },
            async deleteNote() { if(!this.selectedDate) return; await backend.saveNote(this.selectedDate, {}); this.render(); this.closeNoteEditor(); }
        };
        CalendarModule.init();

        // 9. Settings (Camera/Mic/Notifs)
        const SettingsModule = {
            init() {
                $('#save-settings-btn').addEventListener('click', () => this.save());
                $('#reset-app-btn').addEventListener('click', async () => { 
                    if(confirm("Are you sure? This clears all data.")) { 
                        await backend.reset(); 
                        location.reload(); 
                    } 
                });
            },
            async load() {
                const settings = backend.getSettings();
                
                // Notification Settings
                $('#notif-enabled').checked = settings.notifEnabled;
                $('#notif-tone').value = settings.notifTone || 'whistle';

                // Device Enumeration
                if (navigator.mediaDevices && navigator.mediaDevices.enumerateDevices) {
                    try {
                        const devices = await navigator.mediaDevices.enumerateDevices();
                        const videoSelect = $('#camera-select');
                        const audioSelect = $('#mic-select');
                        
                        videoSelect.innerHTML = '<option value="">Default Camera</option>';
                        audioSelect.innerHTML = '<option value="">Default Microphone</option>';

                        devices.forEach(device => {
                            const option = document.createElement('option');
                            option.value = device.deviceId;
                            if (device.kind === 'videoinput') {
                                option.text = device.label || `Camera ${videoSelect.length}`;
                                videoSelect.appendChild(option);
                            } else if (device.kind === 'audioinput') {
                                option.text = device.label || `Microphone ${audioSelect.length}`;
                                audioSelect.appendChild(option);
                            }
                        });

                        videoSelect.value = settings.videoId || "";
                        audioSelect.value = settings.audioId || "";

                    } catch (err) {
                        console.error("Error enumerating devices", err);
                    }
                }
            },
            applyTheme(themeName) {
                const root = document.documentElement;
                if (themeName === 'dark') {
                    root.setAttribute('data-theme', 'dark');
                } else {
                    root.removeAttribute('data-theme');
                }
                $('#theme-select').value = themeName;
            },
            async save() {
                const theme = $('#theme-select').value;
                const notifEnabled = $('#notif-enabled').checked;
                const notifTone = $('#notif-tone').value;
                const videoId = $('#camera-select').value;
                const audioId = $('#mic-select').value;
                
                this.applyTheme(theme);
                await backend.saveSettings({ theme, notifEnabled, notifTone, videoId, audioId });
                showToast("Settings saved", "success");
            }
        };
        SettingsModule.init();

        // 10. Analytics
        const AnalyticsModule = {
            charts: {},
            async render() { 
                const sessions = await backend.getSessions(); 
                const totalMins = sessions.reduce((acc, s) => acc + s.duration, 0); 
                $('#stat-total-time').innerText = totalMins; $('#stat-sessions').innerText = sessions.length; 
                const typeCounts = { focus: 0, break: 0 }; sessions.forEach(s => typeCounts[s.type] = (typeCounts[s.type] || 0) + 1); 
                if(this.charts.weekly) this.charts.weekly.destroy(); 
                if(this.charts.type) this.charts.type.destroy(); 
                
                if (typeof Chart === 'undefined') {
                    console.error("Chart.js not loaded");
                    return;
                }

                const ctx1 = $('#weeklyChart').getContext('2d');
                this.charts.weekly = new Chart(ctx1, { type: 'bar', data: { labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'], datasets: [{ label: 'Minutes Focused', data: [120, 60, 240, 180, 90, 30, 120], backgroundColor: '#764ba2' }] }, options: { responsive: true, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, grid: { color: 'rgba(0,0,0,0.05)' } }, x: { grid: { display: false } } } } });
                const ctx2 = $('#typeChart').getContext('2d');
                this.charts.type = new Chart(ctx2, { type: 'doughnut', data: { labels: ['Focus', 'Break'], datasets: [{ data: [typeCounts.focus || 1, typeCounts.break || 0], backgroundColor: ['#764ba2', '#00c4cc'], borderWidth: 0 }] }, options: { responsive: true, plugins: { legend: { position: 'bottom' } } } });
            }
        };
        $('#refresh-analytics').addEventListener('click', function() { setBtnLoading(this, true); AnalyticsModule.render().then(() => setBtnLoading(this, false)); });

        // Initial Guard
        $$('.btn-primary, .btn-secondary, .btn-danger').forEach(b => b.classList.add('backend-dependent'));
    </script>
</body>
</html>